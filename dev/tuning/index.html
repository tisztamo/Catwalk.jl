<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Configuration &amp; tuning · Catwalk.jl</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit">Catwalk.jl</span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Catwalk.jl Intro</a></li><li><a class="tocitem" href="../usage/">Usage</a></li><li><a class="tocitem" href="../howitworks/">How it works?</a></li><li class="is-active"><a class="tocitem" href>Configuration &amp; tuning</a><ul class="internal"><li><a class="tocitem" href="#Set-up-call-sites"><span>Set up call sites</span></a></li><li><a class="tocitem" href="#Disable-exploring"><span>Disable exploring</span></a></li><li><a class="tocitem" href="#Customize-Profiling"><span>Customize Profiling</span></a></li><li><a class="tocitem" href="#Tune-the-optimizer"><span>Tune the optimizer</span></a></li><li class="toplevel"><a class="tocitem" href="#A-fully-tuned-example"><span>A fully tuned example</span></a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Configuration &amp; tuning</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Configuration &amp; tuning</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/tisztamo/Catwalk.jl/blob/master/docs/src/tuning.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Configuration-and-tuning"><a class="docs-heading-anchor" href="#Configuration-and-tuning">Configuration &amp; tuning</a><a id="Configuration-and-tuning-1"></a><a class="docs-heading-anchor-permalink" href="#Configuration-and-tuning" title="Permalink"></a></h1><p>Catwalk.jl comes with reasonable default configs, but it also allows you to tweak its behavior.</p><p>To monitor its inner workings, start Julia with <code>JULIA_DEBUG=Catwalk</code>.</p><h2 id="Set-up-call-sites"><a class="docs-heading-anchor" href="#Set-up-call-sites">Set up call sites</a><a id="Set-up-call-sites-1"></a><a class="docs-heading-anchor-permalink" href="#Set-up-call-sites" title="Permalink"></a></h2><p>As most of the configuration is done per call site, first you have to set up the call sites with instantiating <code>CallBoost</code>s and provide them to the JIT compiler.</p><pre><code class="language-none">boost1 = Catwalk.CallBoost(:calc_with_x)
boost2 = Catwalk.CallBoost(:another_site)

jit = Catwalk.JIT(boost1, boost2)

# alternatively: Catwalk.add_boost!(jit, boost1)</code></pre><h2 id="Disable-exploring"><a class="docs-heading-anchor" href="#Disable-exploring">Disable exploring</a><a id="Disable-exploring-1"></a><a class="docs-heading-anchor-permalink" href="#Disable-exploring" title="Permalink"></a></h2><p>When all the call sites are set up, you can turn off exploring:</p><pre><code class="language-none">jit = Catwalk.JIT(boost1, boost2; explorerfactory = Catwalk.NoExplorer)</code></pre><h2 id="Customize-Profiling"><a class="docs-heading-anchor" href="#Customize-Profiling">Customize Profiling</a><a id="Customize-Profiling-1"></a><a class="docs-heading-anchor-permalink" href="#Customize-Profiling" title="Permalink"></a></h2><p>Currently only the <code>FullProfiler</code> is available, but it only runs in randomly selected batches, driven by the <code>SparseProfile</code> profile strategy. To change the sparsity of profiling (default is 1%), use:</p><pre><code class="language-none">boost1 = Catwalk.CallBoost(:calc_with_x; profilestrategy = Catwalk.SparseProfile(0.02))</code></pre><p>The profiler will run during the first two rounds in every case, so if you are sure that the distribution of dispatched types does not change significantly during the full run, you can set the sparsity to 0.</p><h2 id="Tune-the-optimizer"><a class="docs-heading-anchor" href="#Tune-the-optimizer">Tune the optimizer</a><a id="Tune-the-optimizer-1"></a><a class="docs-heading-anchor-permalink" href="#Tune-the-optimizer" title="Permalink"></a></h2><p>You can configure different optimizers for every call site. Currently only the <code>TopNOptimizer</code> if available, which generates fast routes for up to the given number of types (10 by default).</p><pre><code class="language-none">boost1 = Catwalk.CallBoost(:calc_with_x; optimizer = Catwalk.TopNOptimizer(50))</code></pre><p>I plan to add an optimizer that calculates marginal utility to decide the number of fast routes, so that tuning N becomes unnecessary.</p><h3 id="Tune-compilation-overhead"><a class="docs-heading-anchor" href="#Tune-compilation-overhead">Tune compilation overhead</a><a id="Tune-compilation-overhead-1"></a><a class="docs-heading-anchor-permalink" href="#Tune-compilation-overhead" title="Permalink"></a></h3><p>The optimizer accepts the <code>compile_threshold</code> argument (1.04 by default). Set it to a higher value if you think there is too much compilation.</p><p>The optimizer maintains a list of all previous compilations and finds the best one from them for the current profile, based on the cost model. If the cost of that historic best compilation is not larger than the cost of the ideal one generated for the current profile, multiplied with <code>compile_threshold</code>, then the historic one will be reused.</p><h3 id="Customize-the-cost-model"><a class="docs-heading-anchor" href="#Customize-the-cost-model">Customize the cost model</a><a id="Customize-the-cost-model-1"></a><a class="docs-heading-anchor-permalink" href="#Customize-the-cost-model" title="Permalink"></a></h3><p>The optimizer also accepts a cost model. The default cost model is the following (costs are measured in clock cycles):</p><pre><code class="language-none">const basemodel = DefaultDispatchCostModel(
    skip                = 3,
    static_dispatch     = 8,
    dynamic_dispatch    = 100,
)</code></pre><p>Where</p><ul><li><code>skip</code> is the cost of an <code>if x isa T</code>: Checking if the current type of the jitted argument equals to a predefined one.</li><li><code>static_dispatch</code> is the cost of a type-stabilized route, <em>not</em> including the skip-cost of that route.</li><li><code>dynamic_dispatch</code> is the original cost of the call with a full dynamic dispatch.</li></ul><p>As the cost of static and dynamic dispatch varies between call sites, you may want to configure the cost model for your case. (It is also possible to define new model types, but it is not documented nor tested yet.)</p><h1 id="A-fully-tuned-example"><a class="docs-heading-anchor" href="#A-fully-tuned-example">A fully tuned example</a><a id="A-fully-tuned-example-1"></a><a class="docs-heading-anchor-permalink" href="#A-fully-tuned-example" title="Permalink"></a></h1><pre><code class="language-julia">    optimizer = JIT(;explorerfactory = Catwalk.NoExplorer)
    Catwalk.add_boost!(
        optimizer,
        Catwalk.CallBoost(
            :calc_with_x,
            profilestrategy  =  Catwalk.SparseProfile(0.02),
            optimizer        =  Catwalk.TopNOptimizer(50;
                                    compile_threshold = 1.1,
                                    costmodel = Catwalk.DefaultDispatchCostModel(
                                        skip                = 2,
                                        static_dispatch     = 8,
                                        dynamic_dispatch    = 1000,
                                    )
                                ),
        )
    )</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../howitworks/">« How it works?</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Sunday 27 February 2022 15:56">Sunday 27 February 2022</span>. Using Julia version 1.7.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
